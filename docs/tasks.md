# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ PMAP (Porta Minimal Agent Protocol)

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Porta –∫–∞–∫ MCP-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è Linux —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∞–≥–µ–Ω—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —á–µ—Ä–µ–∑ PMAP –ø—Ä–æ—Ç–æ–∫–æ–ª.

## üìã –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∞–≥–µ–Ω—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚è≥

#### 1.1 –î–æ–±–∞–≤–∏—Ç—å agent_id –≤–æ –≤—Å–µ POST endpoints
**–§–∞–π–ª:** `porta.py`
**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `agent_id: Optional[str] = None` –≤ –º–æ–¥–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `/run_bash` - –¥–æ–±–∞–≤–∏—Ç—å agent_id –≤ BashCommand
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `/write_file` - –¥–æ–±–∞–≤–∏—Ç—å agent_id –≤ FileWriteRequest  
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `/read_file` - –¥–æ–±–∞–≤–∏—Ç—å agent_id –≤ FileReadRequest
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `/list_dir` - –¥–æ–±–∞–≤–∏—Ç—å agent_id –≤ ListDirRequest
- [ ] –î–æ–±–∞–≤–∏—Ç—å agent_id –≤ –æ—Ç–≤–µ—Ç—ã –≤—Å–µ—Ö endpoints

**–ö–æ–¥:**
```python
class BashCommand(BaseModel):
    cmd: str
    agent_id: Optional[str] = None

class FileWriteRequest(BaseModel):
    path: str
    content: str
    agent_id: Optional[str] = None
```

#### 1.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤
**–§–∞–π–ª:** `porta.py`
**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `log_agent_call(agent_id: str, method: str, result: dict)`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–∞–∂–¥—ã–π endpoint
- [ ] –î–æ–±–∞–≤–∏—Ç—å timestamp –≤ –ª–æ–≥–∏
- [ ] –§–æ—Ä–º–∞—Ç: `[AGENT] {agent_id} called {method}: {result}`

**–ö–æ–¥:**
```python
def log_agent_call(agent_id: str, method: str, result: dict):
    timestamp = datetime.now().isoformat()
    logger.info(f"[AGENT] {agent_id} called {method}: {result} at {timestamp}")
```

#### 1.3 Endpoint `/agent/status`
**–§–∞–π–ª:** `porta.py`
**–ó–∞–¥–∞—á–∏:**
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å AgentStatusRequest
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å POST `/agent/status`
- [ ] –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç–∞—Ç—É—Å, agent_id, timestamp
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤

**–ö–æ–¥:**
```python
@app.post("/agent/status")
async def agent_status(request: AgentStatusRequest):
    result = {
        "status": "ok",
        "agent_id": request.agent_id,
        "timestamp": datetime.now().isoformat()
    }
    log_agent_call(request.agent_id, "agent_status", result)
    return result
```

### –≠—Ç–∞–ø 2: –°–∏—Å—Ç–µ–º–Ω—ã–µ endpoints ‚è≥

#### 2.1 Endpoint `/meta`
**–§–∞–π–ª:** `porta.py`
**–ó–∞–¥–∞—á–∏:**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å GET `/meta`
- [ ] –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Porta
- [ ] –í–∫–ª—é—á–∏—Ç—å –≤–µ—Ä—Å–∏—é, uptime, PID, –ø–æ—Ä—Ç
- [ ] –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö endpoints

**–ö–æ–¥:**
```python
@app.get("/meta")
async def get_meta():
    return {
        "name": "Porta MCP",
        "version": "1.1.0",
        "description": "MCP-–¥—Ä–∞–π–≤–µ—Ä –¥–ª—è Linux",
        "uptime": get_uptime(),
        "pid": os.getpid(),
        "port": 5000,
        "endpoints": ["/", "/run_bash", "/write_file", "/read_file", "/list_dir", "/agent/status", "/meta", "/public_url"]
    }
```

#### 2.2 Endpoint `/public_url`
**–§–∞–π–ª:** `porta.py`
**–ó–∞–¥–∞—á–∏:**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å GET `/public_url`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ngrok API
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ngrok
- [ ] –í–æ–∑–≤—Ä–∞—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL

**–ö–æ–¥:**
```python
@app.get("/public_url")
async def get_public_url():
    try:
        # –ß—Ç–µ–Ω–∏–µ ngrok URL –∏–∑ —Ñ–∞–π–ª–∞
        with open("ngrok.url", "r") as f:
            url = f.read().strip()
        return {"public_url": url, "available": True}
    except FileNotFoundError:
        return {"public_url": None, "available": False}
```

### –≠—Ç–∞–ø 3: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ç–æ–∫–µ–Ω—ã ‚è≥

#### 3.1 –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
**–§–∞–π–ª:** `porta.py`
**–ó–∞–¥–∞—á–∏:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É X-PORTA-TOKEN –∑–∞–≥–æ–ª–æ–≤–∫–∞
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞

**–ö–æ–¥:**
```python
@app.middleware("http")
async def verify_token(request: Request, call_next):
    token = request.headers.get("X-PORTA-TOKEN")
    if token and token != os.getenv("PORTA_TOKEN"):
        return JSONResponse(status_code=401, content={"error": "Invalid token"})
    return await call_next(request)
```

### –≠—Ç–∞–ø 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚è≥

#### 4.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
**–§–∞–π–ª—ã:** `readme.md`, `porta-protocol.md`
**–ó–∞–¥–∞—á–∏:**
- [ ] –û–±–Ω–æ–≤–∏—Ç—å readme.md —Å –Ω–æ–≤—ã–º–∏ endpoints
- [ ] –°–æ–∑–¥–∞—Ç—å porta-protocol.md —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º PMAP
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### 4.2 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ó–∞–¥–∞—á–∏:**
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö endpoints
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ngrok
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –≠—Ç–∞–ø 5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ üîÆ

#### 5.1 –•—Ä–∞–Ω–∏–ª–∏—â–µ –∞–≥–µ–Ω—Ç–æ–≤
**–ó–∞–¥–∞—á–∏:**
- [ ] SQLite –±–∞–∑–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
- [ ] Fallback –Ω–∞ agents.json
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

#### 5.2 –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π API
**–ó–∞–¥–∞—á–∏:**
- [ ] `/agent/exec_pipeline` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–∞–Ω–¥
- [ ] `/agent/history` - –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –∞–≥–µ–Ω—Ç–∞
- [ ] `/agent/files` - —Ñ–∞–π–ª—ã –∞–≥–µ–Ω—Ç–∞

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
```python
class AgentStatusRequest(BaseModel):
    agent_id: str

class AgentResponse(BaseModel):
    success: bool
    agent_id: Optional[str] = None
    timestamp: Optional[str] = None
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –§–æ—Ä–º–∞—Ç: `[AGENT] {agent_id} {method} {result} {timestamp}`
- –£—Ä–æ–≤–µ–Ω—å: INFO
- –§–∞–π–ª: porta.log

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –¢–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PORTA_TOKEN
- –í–∞–ª–∏–¥–∞—Ü–∏—è agent_id (–Ω–µ –ø—É—Å—Ç–æ–π, —Ñ–æ—Ä–º–∞—Ç)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- [ ] –í—Å–µ POST endpoints –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç agent_id
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] `/agent/status` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
- [ ] `/meta` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- [ ] `/public_url` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å ngrok
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞—á–∞—Ç—å —Å –≠—Ç–∞–ø–∞ 1.1** - –¥–æ–±–∞–≤–∏—Ç—å agent_id –≤ –º–æ–¥–µ–ª–∏
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ñ—É–Ω–∫—Ü–∏—è log_agent_call
3. **–°–æ–∑–¥–∞—Ç—å /agent/status** - –±–∞–∑–æ–≤—ã–π endpoint
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
5. **–î–æ–±–∞–≤–∏—Ç—å /meta –∏ /public_url** - —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

## üí° –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

- **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π API
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ endpoints
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –æ–±–Ω–æ–≤–ª—è—Ç—å docs –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∫–æ–¥–æ–º
